{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BMW Animated Flowchart</title>
  <!-- Favicon -->
  <link rel="icon" href="{% static 'images/BMW-logo.png' %}" type="image/x-icon">
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background: #ffffff;
      color: #0b1b2b;
    }

    .wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 16px;
    }

    .logo-row {
      text-align: center;
      margin-bottom: 16px;
    }

    .logo {
      width: 70px;
      height: 70px;
      opacity: 0;
      transform: translateY(-20px);
      animation: logoAppear 1s forwards;
    }

    @keyframes logoAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tree {
      position: relative;
    }

    svg.tree-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .level {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 28px;
      margin-top: 48px;
      position: relative;
      z-index: 2;
    }

    .branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 2;
      opacity: 0;
      transform: translateY(-20px);
    }

    .branch.show {
      animation: branchAppear 0.8s forwards;
    }

    @keyframes branchAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .node {
      padding: 12px 18px;
      border-radius: 10px;
      background: linear-gradient(135deg, #0b3d91, #00c0ff);
      color: white;
      font-weight: 700;
      width: 220px;
      text-align: center;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .leaf {
      padding: 10px 14px;
      border-radius: 8px;
      background: #eef4ff;
      color: #0b3d91;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      box-shadow: 0 4px 10px rgba(11, 61, 145, 0.06);
      position: relative;
      z-index: 2;
      opacity: 0;
      transform: translateY(-10px);
    }

    .leaf.show {
      animation: leafAppear 0.6s forwards;
    }

    @keyframes leafAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .details {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 32px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(9, 30, 66, 0.06);
    }

    .imgwrap {
      width: 420px;
      max-width: 100%;
    }

    .imgwrap img {
      width: 100%;
      border-radius: 8px;
    }

    .info {
      flex: 1;
      min-width: 300px;
    }

    .info h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #0b3d91;
    }

    .specs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
      font-size: 14px;
      color: #667085;
    }

    .path {
      stroke: rgba(11, 61, 145, 0.6);
      stroke-width: 2.4;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: drawLine 0.8s forwards;
      z-index: 1;
    }

    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    @media (max-width:900px) {
      .level {
        flex-direction: column;
        gap: 20px;
      }

      .details {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="treeRoot" class="tree">
      <div id="rootNode" class="node" style="margin-left: 500px;background: none;"><img class="logo"
          src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo"></div>
      <div id="branches" class="level"></div>
      <svg id="connectors" class="tree-svg"></svg>
    </div>

    <div id="details" class="details" style="display:none">
      <div class="card imgwrap"><img id="detailImg" src="" alt="model image"></div>
      <div class="card info">
        <h2 id="detailTitle">Select a model</h2>
        <p id="detailDesc" style="color:#667085; margin-top:8px;"></p>
        <div class="specs">
          <div><strong>Engine:</strong>
            <div id="specEngine"></div>
          </div>
          <div><strong>HP:</strong>
            <div id="specHP"></div>
          </div>
          <div><strong>Top Speed:</strong>
            <div id="specTop"></div>
          </div>
          <div><strong>Price (INR):</strong>
            <div id="specPrice"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadBMW() {
      const res = await fetch("{% static 'bmw_models.json' %}");
      const d = await res.json();
      return d.models;
    }

    function clearSvg() { document.getElementById('connectors').innerHTML = ''; }
    function toSvgCoords(rect, treeRect) { return { x: rect.left + rect.width / 2 - treeRect.left, y: rect.top + rect.height / 2 - treeRect.top }; }

    function drawConnectors() {
      clearSvg();
      const svg = document.getElementById('connectors');
      const rootRect = document.getElementById('rootNode').getBoundingClientRect();
      const treeRect = document.getElementById('treeRoot').getBoundingClientRect();
      const branches = document.querySelectorAll('.branch');

      branches.forEach(branch => {
        const node = branch.querySelector('.node');
        const nodeRect = node.getBoundingClientRect();
        const from = toSvgCoords(rootRect, treeRect);
        const to = toSvgCoords(nodeRect, treeRect);

        // curved path from root to branch
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const midY = from.y + (to.y - from.y) / 2;
        path.setAttribute('d', `M ${from.x} ${from.y} C ${from.x} ${midY} ${to.x} ${midY} ${to.x} ${to.y}`);
        path.setAttribute('class', 'path');
        svg.appendChild(path);

        // curved path from branch to leaves
        const list = branch.querySelector('.sublist');
        if (list && window.getComputedStyle(list).display === 'flex') {
          list.querySelectorAll('.leaf').forEach(leaf => {
            const leafRect = leaf.getBoundingClientRect();
            const leafPt = toSvgCoords(leafRect, treeRect);
            const start = toSvgCoords(nodeRect, treeRect);
            const midY2 = start.y + (leafPt.y - start.y) / 2;
            const pathLeaf = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathLeaf.setAttribute('d', `M ${start.x} ${start.y} C ${start.x} ${midY2} ${leafPt.x} ${midY2} ${leafPt.x} ${leafPt.y}`);
            pathLeaf.setAttribute('class', 'path');
            svg.appendChild(pathLeaf);
          });
        }
      });
    }

    function showDetails(model) {
      document.getElementById('details').style.display = 'flex';
      const img = document.getElementById('detailImg');
      img.src = model.image;
      img.onerror = () => { img.src = 'https://via.placeholder.com/720x400?text=Image+Not+Found' };
      document.getElementById('detailTitle').textContent = model.name;
      document.getElementById('detailDesc').textContent = model.description;
      document.getElementById('specEngine').textContent = model.variants.map(v => v.engine).join(' / ');
      document.getElementById('specHP').textContent = model.variants.map(v => v.horsepower + ' HP').join(' / ');
      document.getElementById('specTop').textContent = model.top_speed + ' km/h';
      document.getElementById('specPrice').textContent = model.variants.map(v => 'â‚¹' + v.price.toLocaleString()).join(' / ');

      let buyBtn = document.getElementById('buyBtn');
      if (!buyBtn) {
        buyBtn = document.createElement('button');
        buyBtn.id = 'buyBtn';
        buyBtn.textContent = 'Buy Now';
        buyBtn.style.marginTop = '16px';
        buyBtn.style.padding = '12px 20px';
        buyBtn.style.background = '#0b3d91';
        buyBtn.style.color = '#fff';
        buyBtn.style.border = 'none';
        buyBtn.style.borderRadius = '6px';
        buyBtn.style.cursor = 'pointer';
        document.getElementById('details').appendChild(buyBtn);
      }
      buyBtn.onclick = () => initiatePayment(model);
    }

    function initiatePayment(model) {
    const amountInPaise = model.variants[0].price * 100;

    fetch('/create_order/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: amountInPaise })
    })
    .then(res => res.json())
    .then(order => {
        const options = {
            "key": "{{ razorpay_key_id }}",
            "amount": order.amount,
            "currency": order.currency,
            "name": "BMW Cars",
            "description": model.name,
            "order_id": order.id,
            "handler": function(response){
                fetch('/payment_success/', {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        model: model.name,
                        price: model.variants[0].price,
                        payment_id: response.razorpay_payment_id
                    })
                }).then(res=>res.json()).then(data=>{
                    if(data.status==='success') alert("Payment successful!");
                });
            },
            "theme": { "color": "#0b3d91" }
        };
        const rzp1 = new Razorpay(options);
        rzp1.open();
    })
    .catch(err => { console.error(err); alert("Payment initiation failed."); });
}


    async function buildTree() {
      const models = await loadBMW();
      const container = document.getElementById('branches');
      container.innerHTML = '';

      const categories = {};
      models.forEach(m => {
        const c = m.category || 'Other';
        if (!categories[c]) categories[c] = [];
        categories[c].push(m);
      });

      let delay = 0;
      for (const [cat, arr] of Object.entries(categories)) {
        const branch = document.createElement('div');
        branch.className = 'branch';
        branch.dataset.key = cat.toLowerCase();

        const node = document.createElement('div');
        node.className = 'node';
        node.textContent = cat;
        node.onclick = () => {
          const list = branch.querySelector('.sublist');
          const vis = window.getComputedStyle(list).display === 'flex';
          document.querySelectorAll('.sublist').forEach(s => s.style.display = 'none');
          if (!vis) list.style.display = 'flex';
          setTimeout(() => { drawConnectors(); animateLeaves(list); }, 200);
        };
        branch.appendChild(node);

        const sublist = document.createElement('div');
        sublist.className = 'sublist';
        sublist.style.display = 'none';
        arr.forEach(m => {
          const leaf = document.createElement('div');
          leaf.className = 'leaf';
          leaf.textContent = m.name;
          leaf.onclick = () => showDetails(m);
          sublist.appendChild(leaf);
        });
        branch.appendChild(sublist);
        container.appendChild(branch);

        setTimeout(() => branch.classList.add('show'), delay);
        delay += 400;
      }

      setTimeout(drawConnectors, delay + 400);
    }

    function animateLeaves(list) {
      if (!list) return;
      const leaves = list.querySelectorAll('.leaf');
      leaves.forEach((leaf, i) => setTimeout(() => leaf.classList.add('show'), i * 150));
    }

    window.addEventListener('load', buildTree);
    window.addEventListener('resize', () => setTimeout(drawConnectors, 300));
  </script>
</body>

</html>
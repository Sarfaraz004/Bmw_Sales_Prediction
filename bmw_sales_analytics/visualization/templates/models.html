{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BMW Models Explorer</title>

  <link rel="icon" href="{% static 'images/BMW-logo.png' %}" type="image/x-icon">

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    /* =======================================
          GLOBAL BMW DARK THEME
    ======================================= */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #050a15; /* same as login */
      color: #e9f1ff;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-animate {
      position: fixed;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 30%, #1616db55 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, #0008ff44 0%, transparent 50%),
        radial-gradient(circle at 50% 90%, #272ae633 0%, transparent 50%);
      filter: blur(55px);
      animation: moveBg 12s infinite alternate ease-in-out;
      z-index: -1;
    }

    @keyframes moveBg {
      0% {
        transform: translate(-5%, -4%);
      }

      100% {
        transform: translate(5%, 4%);
      }
    }

    /* Wrapper */
    .wrap {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    /* =======================================
          BMW LOGO ANIMATION
    ======================================= */
    .logo-row {
      text-align: center;
      margin-bottom: 16px;
    }

    .logo {
      width: 70px;
      opacity: 0;
      transform: translateY(-20px);
      animation: logoAppear 1s forwards;
      filter: drop-shadow(0 0 12px #0070ffbb);
    }

    @keyframes logoAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =======================================
          FLOW TREE STRUCTURE
    ======================================= */
    .tree {
      position: relative;
    }

    svg.tree-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .level {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin-top: 48px;
    }

    .branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0;
      transform: translateY(-20px);
    }

    .branch.show {
      animation: branchAppear 0.8s forwards;
    }

    @keyframes branchAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* BMW Blue Node */
    .node {
      padding: 14px 22px;
      border-radius: 12px;
      background: linear-gradient(135deg, #0b3d91, #00b0ff);
      color: white;
      font-weight: 700;
      width: 240px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 0 18px #007bff55;
      border: 1px solid rgba(255, 255, 255, 0.18);
      transition: .3s;
    }

    .node:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px #009dffaa;
    }

    /* Model Leaves */
    .leaf {
      padding: 12px 16px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: #a8c6ff;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      opacity: 0;
      transform: translateY(-10px);
    }

    .leaf.show {
      animation: leafAppear 0.6s forwards;
    }

    @keyframes leafAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* SVG Path Lines */
    .path {
      stroke: rgba(0, 140, 255, 0.6);
      stroke-width: 2.4;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: drawLine 0.9s forwards;
    }

    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* =======================================
          DETAILS PANEL (GLASS STYLE)
    ======================================= */
    .details {
      display: none;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 40px;
    }

    .card {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(12px);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 0 25px #0079ff33;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .imgwrap {
      width: 420px;
    }

    .imgwrap img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 20px #004fff55;
    }

    .info h2 {
      font-size: 22px;
      color: #5bb8ff;
      margin: 0 0 12px;
    }

    .specs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
      font-size: 15px;
      color: #b8c7ff;
    }

    /* BUY BUTTON */
    #buyBtn {
      background: #0077f7;
      color: white;
      padding: 14px 22px;
      border: none;
      border-radius: 10px;
      margin-top: 18px;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 0 15px #008aff88;
      cursor: pointer;
      transition: .3s;
    }

    #buyBtn:hover {
      transform: scale(1.04);
      box-shadow: 0 0 25px #00aaffaa;
    }

    @media (max-width: 900px) {
      .level {
        flex-direction: column;
      }

      .details {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <!-- Animated Background -->
  <div class="bg-animate"></div>

  <div class="wrap">

    <!-- LOGO -->
    <div id="treeRoot" class="tree">
      <div id="rootNode" class="node" style="margin-left: 500px; background: none; box-shadow:none;">
        <img class="logo" src="{% static 'images/BMW-logo.png' %}" alt="BMW Logo">
      </div>

      <div id="branches" class="level"></div>
      <svg id="connectors" class="tree-svg"></svg>
    </div>

    <!-- DETAILS PANEL -->
    <div id="details" class="details">
      <div class="card imgwrap"><img id="detailImg" src="" alt="model image"></div>

      <div class="card info">
        <h2 id="detailTitle">Select a model</h2>
        <p id="detailDesc" style="color:#a8c6ff; margin-top:8px;"></p>

        <div class="specs">
          <div><strong>Engine:</strong> <div id="specEngine"></div></div>
          <div><strong>HP:</strong> <div id="specHP"></div></div>
          <div><strong>Top Speed:</strong> <div id="specTop"></div></div>
          <div><strong>Price (INR):</strong> <div id="specPrice"></div></div>
        </div>
      </div>
    </div>

  </div>


  <!-- Keep your JS exactly same -->
  <script>
    /* your entire JS below remains unchanged */
    /* -------------------------------------- */
    async function loadBMW() {
      const res = await fetch("{% static 'bmw_models.json' %}");
      const d = await res.json();
      return d.models;
    }

    function clearSvg() { document.getElementById('connectors').innerHTML = ''; }
    function toSvgCoords(rect, treeRect) { return { x: rect.left + rect.width / 2 - treeRect.left, y: rect.top + rect.height / 2 - treeRect.top }; }

    function drawConnectors() {
      clearSvg();
      const svg = document.getElementById('connectors');
      const rootRect = document.getElementById('rootNode').getBoundingClientRect();
      const treeRect = document.getElementById('treeRoot').getBoundingClientRect();
      const branches = document.querySelectorAll('.branch');

      branches.forEach(branch => {
        const node = branch.querySelector('.node');
        const nodeRect = node.getBoundingClientRect();
        const from = toSvgCoords(rootRect, treeRect);
        const to = toSvgCoords(nodeRect, treeRect);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const midY = from.y + (to.y - from.y) / 2;
        path.setAttribute('d', `M ${from.x} ${from.y} C ${from.x} ${midY} ${to.x} ${midY} ${to.x} ${to.y}`);
        path.setAttribute('class', 'path');
        svg.appendChild(path);

        const list = branch.querySelector('.sublist');
        if (list && window.getComputedStyle(list).display === 'flex') {
          list.querySelectorAll('.leaf').forEach(leaf => {
            const leafRect = leaf.getBoundingClientRect();
            const leafPt = toSvgCoords(leafRect, treeRect);
            const start = toSvgCoords(nodeRect, treeRect);
            const midY2 = start.y + (leafPt.y - start.y) / 2;

            const pathLeaf = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathLeaf.setAttribute('d', `M ${start.x} ${start.y} C ${start.x} ${midY2} ${leafPt.x} ${midY2} ${leafPt.x} ${leafPt.y}`);
            pathLeaf.setAttribute('class', 'path');
            svg.appendChild(pathLeaf);
          });
        }
      });
    }

    function showDetails(model) {
      document.getElementById('details').style.display = 'flex';
      const img = document.getElementById('detailImg');
      img.src = model.image;
      img.onerror = () => { img.src = 'https://via.placeholder.com/720x400?text=Image+Not+Found' };

      document.getElementById('detailTitle').textContent = model.name;
      document.getElementById('detailDesc').textContent = model.description;
      document.getElementById('specEngine').textContent = model.variants.map(v => v.engine).join(' / ');
      document.getElementById('specHP').textContent = model.variants.map(v => v.horsepower + ' HP').join(' / ');
      document.getElementById('specTop').textContent = model.top_speed + ' km/h';
      document.getElementById('specPrice').textContent = model.variants.map(v => 'â‚¹' + v.price.toLocaleString()).join(' / ');

      let buyBtn = document.getElementById('buyBtn');
      if (!buyBtn) {
        buyBtn = document.createElement('button');
        buyBtn.id = 'buyBtn';
        buyBtn.textContent = 'Buy Now';
        document.getElementById('details').appendChild(buyBtn);
      }

      buyBtn.onclick = () => initiatePayment(model);
    }

    function initiatePayment(model) {
      const amountInPaise = model.variants[0].price * 100;

      fetch('/create_order/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: amountInPaise })
      })
        .then(res => res.json())
        .then(order => {
          const options = {
            "key": "{{ razorpay_key_id }}",
            "amount": order.amount,
            "currency": order.currency,
            "name": "BMW Cars",
            "description": model.name,
            "order_id": order.id,
            "handler": function (response) {
              fetch('/payment_success/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  model: model.name,
                  price: model.variants[0].price,
                  payment_id: response.razorpay_payment_id
                })
              }).then(res => res.json()).then(data => {
                if (data.status === 'success') alert("Payment successful!");
              });
            },
            "theme": { "color": "#0b3d91" }
          };
          const rzp1 = new Razorpay(options);
          rzp1.open();
        })
        .catch(err => { console.error(err); alert("Payment initiation failed."); });
    }

    async function buildTree() {
      const models = await loadBMW();
      const container = document.getElementById('branches');
      container.innerHTML = '';

      const categories = {};
      models.forEach(m => {
        const c = m.category || 'Other';
        if (!categories[c]) categories[c] = [];
        categories[c].push(m);
      });

      let delay = 0;
      for (const [cat, arr] of Object.entries(categories)) {
        const branch = document.createElement('div');
        branch.className = 'branch';

        const node = document.createElement('div');
        node.className = 'node';
        node.textContent = cat;

        node.onclick = () => {
          const list = branch.querySelector('.sublist');
          const vis = window.getComputedStyle(list).display === 'flex';
          document.querySelectorAll('.sublist').forEach(s => s.style.display = 'none');

          if (!vis) list.style.display = 'flex';

          setTimeout(() => { drawConnectors(); animateLeaves(list); }, 200);
        };

        branch.appendChild(node);

        const sublist = document.createElement('div');
        sublist.className = 'sublist';
        sublist.style.display = 'none';

        arr.forEach(m => {
          const leaf = document.createElement('div');
          leaf.className = 'leaf';
          leaf.textContent = m.name;
          leaf.onclick = () => showDetails(m);
          sublist.appendChild(leaf);
        });

        branch.appendChild(sublist);
        container.appendChild(branch);

        setTimeout(() => branch.classList.add('show'), delay);
        delay += 350;
      }

      setTimeout(drawConnectors, delay + 400);
    }

    function animateLeaves(list) {
      if (!list) return;
      const leaves = list.querySelectorAll('.leaf');
      leaves.forEach((leaf, i) => setTimeout(() => leaf.classList.add('show'), i * 150));
    }

    window.addEventListener('load', buildTree);
    window.addEventListener('resize', () => setTimeout(drawConnectors, 300));
  </script>
</body>

</html>
